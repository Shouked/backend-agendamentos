<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel do Proprietário</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 10px;
        background: linear-gradient(135deg, #f9e6f0, #fce4ec);
        color: #333;
      }
      .container {
        max-width: 100%;
        margin: 0 auto;
        padding: 15px;
        background: white;
        border-radius: 15px;
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
      }
      h2 {
        text-align: center;
        color: #d81b60;
        margin-bottom: 20px;
        font-size: 24px;
      }
      .dashboard {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
      }
      .dashboard-button {
        background-color: #e91e63;
        color: white;
        padding: 15px 20px;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        cursor: pointer;
        transition: background-color 0.3s;
        flex: 1 1 250px;
        max-width: 300px;
      }
      .dashboard-button:hover {
        background-color: #c2185b;
      }
      .section {
        display: none;
        margin-top: 20px;
        padding: 15px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      input, select, button {
        padding: 10px;
        margin: 5px 0;
        border: 2px solid #e91e63;
        border-radius: 5px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
      }
      button {
        background-color: #e91e63;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
      }
      button:hover {
        background-color: #c2185b;
      }
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
      }
      .action-buttons button {
        flex: 1;
        padding: 10px;
        font-size: 14px;
      }
      .bulk-delete-btn {
        background-color: #f44336;
      }
      #agendamentosList {
        width: 100%;
        border-collapse: collapse;
      }
      #agendamentosList .date-header {
        background-color: #e91e63;
        color: white;
        padding: 10px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 5px 5px 0 0;
      }
      #agendamentosList .event-row {
        display: flex;
        align-items: center;
        padding: 8px;
        border-bottom: 1px solid #ddd;
        cursor: pointer;
        font-size: 14px;
      }
      #agendamentosList .event-checkbox {
        margin-right: 10px;
      }
      #agendamentosList .event-name {
        flex-grow: 1;
        word-break: break-word;
        max-width: 50%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      #agendamentosList .event-details {
        margin-left: 10px;
        font-size: 12px;
      }
      .erro {
        color: red;
        font-size: 12px;
        display: block;
        margin-top: -5px;
      }
      .modal {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 1000;
        width: 90%;
        max-width: 400px;
        text-align: center;
      }
      .overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 999;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
        word-break: break-word;
      }
      th {
        background-color: #e91e63;
        color: white;
      }
      @media (max-width: 600px) {
        .dashboard-button {
          flex: 1 1 100%;
          max-width: none;
          padding: 8px;
        }
        #agendamentosList .date-header {
          font-size: 14px;
          padding: 8px;
        }
        #agendamentosList .event-row {
          font-size: 12px;
          padding: 6px;
        }
        #agendamentosList .event-name {
          max-width: 40%;
        }
        #agendamentosList .event-details {
          font-size: 10px;
        }
        .container {
          padding: 10px;
          margin: 5px;
        }
        table, thead, tbody, th, td, tr {
          display: block;
        }
        thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }
        tr {
          margin-bottom: 8px;
          border: 1px solid #ddd;
          border-radius: 4px;
        }
        td {
          border: none;
          position: relative;
          padding-left: 35%;
          text-align: left;
        }
        td:before {
          position: absolute;
          left: 8px;
          content: attr(data-label);
          font-weight: bold;
          font-size: 10px;
          color: #e91e63;
        }
        td:nth-child(1):before { content: "Selecionar"; }
        td:nth-child(2):before { content: "Nome"; }
        td:nth-child(3):before { content: "E-mail"; }
        td:nth-child(4):before { content: "Telefone"; }
        td:nth-child(5):before { content: "Data Registro"; }
      }
    </style>
  </head>
  <body>
    <div class="container" id="login">
      <h2>Login do Proprietário</h2>
      <input type="email" id="email" placeholder="E-mail" /><br />
      <input type="password" id="senha" placeholder="Senha" /><br />
      <button onclick="login()">Entrar</button>
    </div>
    <div class="container" id="painel" style="display: none">
      <h2>Painel do Proprietário</h2>
      <div class="dashboard">
        <button class="dashboard-button" onclick="toggleSection('agendamentoSection')">Agendar Procedimento</button>
        <button class="dashboard-button" onclick="toggleSection('agendamentosSection')">Ver Agendamentos</button>
        <button class="dashboard-button" onclick="toggleSection('clientesSection')">Lista de Clientes</button>
      </div>

      <div id="agendamentoSection" class="section">
        <h3>Criar Novo Agendamento</h3>
        <select id="procedimento" required>
          <option value="">Escolha o procedimento</option>
          <option value="Extensão de Cílios">Extensão de Cílios</option>
          <option value="Lábios">Lábios</option>
          <option value="Sobrancelha">Sobrancelha</option>
        </select>
        <span id="erroProcedimento" class="erro"></span>
        <input type="text" id="data" placeholder="Selecione a data" required>
        <span id="erroData" class="erro"></span>
        <select id="horario" required>
          <option value="">Selecione o horário</option>
        </select>
        <span id="erroHorario" class="erro"></span>
        <input type="text" id="cliente" placeholder="Nome do cliente" required oninput="formatarNome(this);">
        <span id="erroCliente" class="erro"></span>
        <input type="tel" id="telefone" placeholder="Telefone (ex.: (11) 98765-4321)" required oninput="mascararTelefone(this);">
        <span id="erroTelefone" class="erro"></span>
        <input type="email" id="emailAgendamento" placeholder="E-mail do cliente" oninput="this.value = this.value.toLowerCase();">
        <span id="erroEmail" class="erro"></span>
        <button onclick="criarAgendamento()">Criar Agendamento</button>
      </div>

      <div id="agendamentosSection" class="section">
        <h3>Lista de Agendamentos</h3>
        <div class="action-buttons">
          <button onclick="selecionarTodosAgendamentos()">Selecionar Todos</button>
          <button class="bulk-delete-btn" onclick="excluirSelecionadosAgendamentos()">Excluir Selecionados</button>
        </div>
        <div id="agendamentosList"></div>
      </div>

      <div id="clientesSection" class="section">
        <h3>Clientes Registrados</h3>
        <div class="action-buttons">
          <button onclick="selecionarTodosClientes()">Selecionar Todos</button>
          <button class="bulk-delete-btn" onclick="excluirSelecionadosClientes()">Excluir Selecionados</button>
        </div>
        <table id="clientesTable">
          <thead>
            <tr>
              <th>Selecionar</th>
              <th>Nome</th>
              <th>E-mail</th>
              <th>Telefone</th>
              <th>Data Registro</th>
            </tr>
          </thead>
          <tbody id="listaClientes"></tbody>
        </table>
      </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="editModal">
      <h3>Editar Agendamento</h3>
      <input type="hidden" id="editId">
      <select id="editProcedimento">
        <option value="Extensão de Cílios">Extensão de Cílios</option>
        <option value="Lábios">Lábios</option>
        <option value="Sobrancelha">Sobrancelha</option>
      </select>
      <input type="text" id="editData" placeholder="Selecione a data">
      <select id="editHorario">
        <option value="">Selecione o horário</option>
      </select>
      <button onclick="salvarEdicao()">Salvar</button>
      <button onclick="fecharModal()">Cancelar</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>
    <script>
      const API_URL = "https://agendamentos-backend.onrender.com";
      let token = null;
      let selectedEventId = null;

      async function login() {
        const email = document.getElementById("email").value;
        const senha = document.getElementById("senha").value;
        try {
          const response = await fetch(`${API_URL}/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, senha }),
          });
          const result = await response.json();
          if (result.success) {
            token = result.token;
            document.getElementById("login").style.display = "none";
            document.getElementById("painel").style.display = "block";
            inicializarFlatpickr();
            await carregarClientes();
          } else {
            alert("E-mail ou senha inválidos!");
          }
        } catch (error) {
          console.error('Erro ao fazer login:', error);
          alert('Erro ao conectar ao servidor. Tente novamente.');
        }
      }

      function toggleSection(sectionId) {
        const sections = ['agendamentoSection', 'agendamentosSection', 'clientesSection'];
        sections.forEach(id => {
          const section = document.getElementById(id);
          if (id === sectionId) {
            section.style.display = section.style.display === 'block' ? 'none' : 'block';
            if (id === 'agendamentosSection' && section.style.display === 'block') {
              carregarAgendamentos();
            } else if (id === 'clientesSection' && section.style.display === 'block') {
              carregarClientes();
            }
          } else {
            section.style.display = 'none';
          }
        });
      }

      function inicializarFlatpickr() {
        flatpickr("#data", {
          minDate: "today",
          dateFormat: "d/m/Y",
          disable: [
            function(date) {
              return date.getDay() === 0;
            }
          ],
          locale: "pt",
          onChange: async function(selectedDates, dateStr) {
            await carregarHorariosDisponiveis(dateStr, 'horario');
          }
        });
        flatpickr("#editData", {
          minDate: "today",
          dateFormat: "d/m/Y",
          disable: [
            function(date) {
              return date.getDay() === 0;
            }
          ],
          locale: "pt",
          onChange: async function(selectedDates, dateStr) {
            await carregarHorariosDisponiveis(dateStr, 'editHorario');
          }
        });
      }

      async function carregarHorariosDisponiveis(data, selectId) {
        const [day, month, year] = data.split('/');
        const dataISO = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        try {
          const response = await fetch(`${API_URL}/horarios-disponiveis?data=${dataISO}`, {
            headers: { Authorization: token }
          });
          const horarios = await response.json();
          const horarioSelect = document.getElementById(selectId);
          horarioSelect.innerHTML = '<option value="">Selecione o horário</option>';
          horarios.forEach(horario => {
            const option = document.createElement('option');
            option.value = horario;
            option.textContent = horario;
            horarioSelect.appendChild(option);
          });
        } catch (error) {
          console.error('Erro ao carregar horários:', error);
          alert('Erro ao carregar horários. Tente novamente.');
        }
      }

      function formatarNome(input) {
        let value = input.value.toLowerCase();
        input.value = value.replace(/\b\w/g, char => char.toUpperCase());
      }

      function mascararTelefone(input) {
        let value = input.value.replace(/\D/g, '');
        if (value.length > 11) value = value.slice(0, 11);
        if (value.length <= 10) {
          if (value.length > 2) value = `(${value.slice(0, 2)}) ${value.slice(2, 6)}-${value.slice(6)}`;
          else if (value.length > 0) value = `(${value}`;
        } else {
          if (value.length > 2) value = `(${value.slice(0, 2)}) ${value.slice(2, 7)}-${value.slice(7)}`;
          else if (value.length > 0) value = `(${value}`;
        }
        input.value = value;
      }

      async function carregarAgendamentos() {
        try {
          const response = await fetch(`${API_URL}/agendamentos`, {
            headers: { Authorization: token },
          });
          const agendamentos = await response.json();
          console.log('Agendamentos carregados:', agendamentos);

          const list = document.getElementById('agendamentosList');
          list.innerHTML = '';

          // Agrupa por data
          const groupedByDate = agendamentos.reduce((acc, ag) => {
            const date = new Date(ag.data).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
            if (!acc[date]) acc[date] = [];
            acc[date].push(ag);
            return acc;
          }, {});

          for (const date in groupedByDate) {
            const agendamentosDoDia = groupedByDate[date];
            const total = agendamentosDoDia.length;

            // Cabeçalho da data
            const dateHeader = document.createElement('div');
            dateHeader.className = 'date-header';
            dateHeader.textContent = `${date} - ${total} pessoa${total > 1 ? 's' : ''} agendadas`;
            list.appendChild(dateHeader);

            // Lista de agendamentos do dia com checkboxes
            agendamentosDoDia.forEach(ag => {
              const row = document.createElement('div');
              row.className = 'event-row';
              row.setAttribute('data-id', ag._id);
              row.innerHTML = `
                <input type="checkbox" class="select-agendamento" value="${ag._id}" onclick="event.stopPropagation();">
                <span class="event-name" onclick="abrirModalEditar('${ag._id}')">${ag.cliente}</span>
                <span class="event-details">${ag.procedimento} - ${ag.horario}</span>
              `;
              list.appendChild(row);
            });
          }
        } catch (error) {
          console.error('Erro ao carregar agendamentos:', error);
          alert('Erro ao carregar agendamentos. Tente novamente.');
        }
      }

      async function criarAgendamento() {
        document.getElementById('erroProcedimento').textContent = '';
        document.getElementById('erroData').textContent = '';
        document.getElementById('erroHorario').textContent = '';
        document.getElementById('erroCliente').textContent = '';
        document.getElementById('erroTelefone').textContent = '';
        document.getElementById('erroEmail').textContent = '';

        const procedimento = document.getElementById('procedimento').value;
        const dataBr = document.getElementById('data').value;
        const horario = document.getElementById('horario').value;
        const cliente = document.getElementById('cliente').value;
        const telefone = document.getElementById('telefone').value.replace(/\D/g, '');
        let email = document.getElementById('emailAgendamento').value;

        if (!procedimento) {
          document.getElementById('erroProcedimento').textContent = "Escolha um procedimento!";
          return;
        }
        if (!dataBr) {
          document.getElementById('erroData').textContent = "Selecione uma data!";
          return;
        }
        if (!horario) {
          document.getElementById('erroHorario').textContent = "Selecione um horário!";
          return;
        }
        if (!cliente) {
          document.getElementById('erroCliente').textContent = "Digite o nome do cliente!";
          return;
        }
        if (!telefone || telefone.length < 10) {
          document.getElementById('erroTelefone').textContent = "Digite um telefone válido (10 ou 11 dígitos)!";
          return;
        }

        const [day, month, year] = dataBr.split('/');
        const data = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
        const agendamentoDados = { procedimento, data, horario, cliente, telefone, email };

        try {
          const response = await fetch(`${API_URL}/agendamentos`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': token
            },
            body: JSON.stringify(agendamentoDados)
          });
          const result = await response.json();
          if (result.success) {
            alert("Agendamento criado com sucesso! O cliente receberá uma confirmação por e-mail.");
            document.getElementById('procedimento').value = '';
            document.getElementById('data').value = '';
            document.getElementById('horario').innerHTML = '<option value="">Selecione o horário</option>';
            document.getElementById('cliente').value = '';
            document.getElementById('telefone').value = '';
            document.getElementById('emailAgendamento').value = '';
            toggleSection('agendamentoSection');
            await carregarAgendamentos();
          } else {
            alert(result.message || "Erro ao criar agendamento!");
          }
        } catch (error) {
          console.error('Erro ao criar agendamento:', error);
          alert('Erro ao conectar ao servidor. Tente novamente.');
        }
      }

      async function carregarClientes() {
        try {
          const response = await fetch(`${API_URL}/clientes`, {
            headers: { Authorization: token },
          });
          const clientes = await response.json();
          console.log('Clientes carregados:', clientes);
          const lista = document.getElementById('listaClientes');
          lista.innerHTML = '';
          clientes.forEach(cliente => {
            const dataRegistro = cliente.dataCriacao ? new Date(cliente.dataCriacao).toLocaleDateString('pt-BR') : 'Data não disponível';
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td data-label="Selecionar"><input type="checkbox" class="select-cliente" value="${cliente._id}"></td>
              <td data-label="Nome">${cliente.nome}</td>
              <td data-label="E-mail">${cliente.email}</td>
              <td data-label="Telefone">${cliente.telefone}</td>
              <td data-label="Data Registro">${dataRegistro}</td>
            `;
            lista.appendChild(tr);
          });
        } catch (error) {
          console.error('Erro ao carregar clientes:', error);
          alert('Erro ao carregar clientes. Tente novamente.');
        }
      }

      function abrirModalEditar(id) {
        document.getElementById('editId').value = id;
        document.getElementById('overlay').style.display = 'block';
        document.getElementById('editModal').style.display = 'block';
      }

      async function salvarEdicao() {
        const id = document.getElementById('editId').value;
        const procedimento = document.getElementById('editProcedimento').value;
        const dataBr = document.getElementById('editData').value;
        const horario = document.getElementById('editHorario').value;

        const body = { procedimento };
        if (dataBr && horario) {
          const [day, month, year] = dataBr.split('/');
          const data = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}`;
          body.data = data;
          body.horario = horario;
        }

        try {
          const response = await fetch(`${API_URL}/agendamentos/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': token
            },
            body: JSON.stringify(body)
          });
          const result = await response.json();
          if (result.success) {
            alert('Agendamento atualizado com sucesso!');
            fecharModal();
            await carregarAgendamentos();
          } else {
            alert(result.message || 'Erro ao atualizar!');
          }
        } catch (error) {
          console.error('Erro ao salvar edição:', error);
          alert('Erro ao conectar ao servidor. Tente novamente.');
        }
      }

      function fecharModal() {
        document.getElementById('overlay').style.display = 'none';
        document.getElementById('editModal').style.display = 'none';
      }

      function selecionarTodosAgendamentos() {
        const checkboxes = document.querySelectorAll(".select-agendamento");
        checkboxes.forEach((cb) => (cb.checked = true));
      }

      async function excluirSelecionadosAgendamentos() {
        const selecionados = Array.from(
          document.querySelectorAll(".select-agendamento:checked")
        ).map((cb) => cb.value);
        if (selecionados.length === 0) {
          alert("Nenhum agendamento selecionado!");
          return;
        }
        if (
          confirm(
            `Tem certeza que deseja excluir ${selecionados.length} agendamento(s)?`
          )
        ) {
          try {
            const response = await fetch(`${API_URL}/agendamentos/muitos`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: token,
              },
              body: JSON.stringify({ ids: selecionados }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              await carregarAgendamentos();
            } else {
              alert(result.message || "Erro ao excluir agendamentos!");
            }
          } catch (error) {
            console.error('Erro ao excluir agendamentos:', error);
            alert('Erro ao conectar ao servidor. Tente novamente.');
          }
        }
      }

      function selecionarTodosClientes() {
        const checkboxes = document.querySelectorAll(".select-cliente");
        checkboxes.forEach((cb) => (cb.checked = true));
      }

      async function excluirSelecionadosClientes() {
        const selecionados = Array.from(
          document.querySelectorAll(".select-cliente:checked")
        ).map((cb) => cb.value);
        if (selecionados.length === 0) {
          alert("Nenhum cliente selecionado!");
          return;
        }
        if (
          confirm(
            `Tem certeza que deseja excluir ${selecionados.length} cliente(s)?`
          )
        ) {
          try {
            const response = await fetch(`${API_URL}/clientes/muitos`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
                Authorization: token,
              },
              body: JSON.stringify({ ids: selecionados }),
            });
            const result = await response.json();
            if (result.success) {
              alert(result.message);
              await carregarClientes();
            } else {
              alert(result.message || "Erro ao excluir clientes!");
            }
          } catch (error) {
            console.error('Erro ao excluir clientes:', error);
            alert('Erro ao conectar ao servidor. Tente novamente.');
          }
        }
      }
    </script>
  </body>
</html>
